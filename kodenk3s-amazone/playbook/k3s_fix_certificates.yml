---
- name: Fix K3s Agent Certificate Issues - Reinstall Agents
  hosts: k8s_workers
  become: true
  serial: 1
  gather_facts: true
  vars:
    k3s_install_url: https://get.k3s.io
    target_k3s_version: v1.32.6+k3s1
  
  tasks:
    - name: Stop K3s agent service
      ansible.builtin.systemd:
        name: k3s-agent
        state: stopped
      failed_when: false

    - name: Remove old K3s agent files and certificates
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      with_items:
        - /etc/systemd/system/k3s-agent.service
        - /etc/systemd/system/k3s-agent.service.env
        - /var/lib/rancher/k3s
        - /etc/rancher
      
    - name: Reload systemd daemon
      ansible.builtin.systemd:
        daemon_reload: true

    - name: Get fresh master token
      ansible.builtin.slurp:
        src: /var/lib/rancher/k3s/server/node-token
      register: master_token_b64
      delegate_to: "{{ groups['k8s_master'][0] }}"
      
    - name: Set connection facts
      ansible.builtin.set_fact:
        master_ip: "{{ hostvars[groups['k8s_master'][0]]['ansible_host'] }}"
        master_token: "{{ master_token_b64.content | b64decode | trim }}"
      
    - name: Show connection info
      ansible.builtin.debug:
        msg: "Connecting {{ inventory_hostname }} to master {{ master_ip }} with fresh token"

    - name: Reinstall K3s agent with fresh certificates
      ansible.builtin.shell: |
        curl -sfL {{ k3s_install_url }} | INSTALL_K3S_VERSION={{ target_k3s_version }} K3S_URL=https://{{ master_ip }}:6443 K3S_TOKEN={{ master_token }} sh -
      register: install_result
      
    - name: Show install result
      ansible.builtin.debug:
        msg: "Install result: {{ install_result.rc }}"
      when: install_result.rc is defined

    - name: Wait for agent to start
      ansible.builtin.pause:
        seconds: 10
        
    - name: Check agent service status
      ansible.builtin.systemd:
        name: k3s-agent
      register: agent_status
      
    - name: Show agent status
      ansible.builtin.debug:
        msg: "{{ inventory_hostname }} agent status: {{ agent_status.status.ActiveState }}"

- name: Verify Cluster Status
  hosts: k8s_master
  become: true
  
  tasks:
    - name: Wait for all nodes to register
      ansible.builtin.pause:
        seconds: 20
        
    - name: Check final cluster status
      ansible.builtin.shell: /usr/local/bin/k3s kubectl get nodes -o wide
      register: cluster_status
      
    - name: Display final cluster status
      ansible.builtin.debug:
        var: cluster_status.stdout_lines
