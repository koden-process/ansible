---
- name: K3s Cluster Diagnostic and Fix
  hosts: k8s_nodes
  become: yes
  vars:
    # Utilisation de la même version pour tous les nœuds
    k3s_version: v1.32.6+k3s1  # Version cible pour tous les nœuds
    k3s_install_url: https://get.k3s.io
    
  tasks:
    - name: Gather system information
      ansible.builtin.setup:
        gather_subset:
          - hardware
          - network
          - virtual

    - name: Check if K3s is installed
      ansible.builtin.stat:
        path: /usr/local/bin/k3s
      register: k3s_binary

    - name: Check current K3s version if installed
      ansible.builtin.shell: /usr/local/bin/k3s --version | head -1
      register: current_k3s_version
      when: k3s_binary.stat.exists
      ignore_errors: yes

    - name: Display current K3s version
      ansible.builtin.debug:
        msg: "Current K3s version: {{ current_k3s_version.stdout | default('Not installed') }}"

    - name: Check K3s service status (master)
      ansible.builtin.systemd:
        name: k3s
      register: k3s_master_service
      when: inventory_hostname in groups['k8s_master']
      ignore_errors: yes

    - name: Check K3s agent service status (workers)
      ansible.builtin.systemd:
        name: k3s-agent
      register: k3s_agent_service
      when: inventory_hostname in groups['k8s_workers']
      ignore_errors: yes

    - name: Display service status
      ansible.builtin.debug:
        msg: |
          Master service status: {{ k3s_master_service.status.ActiveState | default('N/A') }}
          Agent service status: {{ k3s_agent_service.status.ActiveState | default('N/A') }}

    # Correction pour les workers avec mauvaise version
    - name: Stop K3s agent on workers if version mismatch
      ansible.builtin.systemd:
        name: k3s-agent
        state: stopped
      when: 
        - inventory_hostname in groups['k8s_workers']
        - k3s_binary.stat.exists
        - current_k3s_version.stdout is defined
        - k3s_version not in current_k3s_version.stdout
      ignore_errors: yes

    - name: Remove K3s agent service file if version mismatch
      ansible.builtin.file:
        path: /etc/systemd/system/k3s-agent.service
        state: absent
      when: 
        - inventory_hostname in groups['k8s_workers']
        - k3s_binary.stat.exists
        - current_k3s_version.stdout is defined
        - k3s_version not in current_k3s_version.stdout

    - name: Remove K3s binary if version mismatch
      ansible.builtin.file:
        path: /usr/local/bin/k3s
        state: absent
      when: 
        - inventory_hostname in groups['k8s_workers']
        - k3s_binary.stat.exists
        - current_k3s_version.stdout is defined
        - k3s_version not in current_k3s_version.stdout

    - name: Get master node token
      ansible.builtin.slurp:
        src: /var/lib/rancher/k3s/server/node-token
      register: k3s_token_file
      when: inventory_hostname in groups['k8s_master']
      
    - name: Store master token as fact
      ansible.builtin.set_fact:
        k3s_token: "{{ k3s_token_file.content | b64decode | trim }}"
      when: inventory_hostname in groups['k8s_master']

    - name: Get master IP
      ansible.builtin.set_fact:
        master_ip: "{{ hostvars[groups['k8s_master'][0]]['ansible_default_ipv4']['address'] }}"

    - name: Reinstall K3s on workers with correct version
      ansible.builtin.shell: |
        curl -sfL {{ k3s_install_url }} | INSTALL_K3S_VERSION={{ k3s_version }} K3S_URL=https://{{ master_ip }}:6443 K3S_TOKEN={{ hostvars[groups['k8s_master'][0]]['k3s_token'] }} sh -
      when: 
        - inventory_hostname in groups['k8s_workers']
        - hostvars[groups['k8s_master'][0]]['k3s_token'] is defined
      register: reinstall_result
      ignore_errors: yes

    - name: Wait for K3s agent service to be ready
      ansible.builtin.systemd:
        name: k3s-agent
        state: started
        enabled: yes
      when: inventory_hostname in groups['k8s_workers']
      register: agent_start
      retries: 5
      delay: 10
      until: agent_start is succeeded

    - name: Check agent logs if installation failed
      ansible.builtin.shell: journalctl -u k3s-agent --no-pager -l | tail -50
      register: agent_logs
      when: 
        - inventory_hostname in groups['k8s_workers']
        - reinstall_result is defined
        - reinstall_result.failed is defined
        - reinstall_result.failed

    - name: Display agent logs if failed
      ansible.builtin.debug:
        var: agent_logs.stdout_lines
      when: 
        - inventory_hostname in groups['k8s_workers']
        - agent_logs is defined
        - agent_logs.stdout is defined

    - name: Verify node connectivity from master
      ansible.builtin.shell: /usr/local/bin/k3s kubectl get nodes
      register: node_status
      when: inventory_hostname in groups['k8s_master']

    - name: Display cluster status
      ansible.builtin.debug:
        var: node_status.stdout_lines
      when: 
        - inventory_hostname in groups['k8s_master']
        - node_status.stdout is defined