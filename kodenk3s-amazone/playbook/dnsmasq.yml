---
- name: Install and configure dnsmasq on koden0
  hosts: k8s_master
  become: true
  vars:
    dns_domain: "amazone.lan"
    dns_ip: "10.0.0.200"
    stormshield_ip: "10.0.0.254"
    upstream_dns:
      - "8.8.8.8"
      - "1.1.1.1"

  tasks:
    - name: Install dnsmasq package
      ansible.builtin.package:
        name: dnsmasq
        state: present

    - name: Detect main network interface
      ansible.builtin.shell: |
        set -o pipefail
        ip route | grep default | head -1 | awk '{print $5}'
      register: main_interface
      changed_when: false
      args:
        executable: /bin/bash

    - name: Display detected interface
      ansible.builtin.debug:
        msg: "Interface dÃ©tectÃ©e: {{ main_interface.stdout }}"

    - name: Stop dnsmasq service
      ansible.builtin.systemd:
        name: dnsmasq
        state: stopped
      failed_when: false

    - name: Create main dnsmasq configuration
      ansible.builtin.copy:
        content: |
          # Configuration dnsmasq pour koden0
          port=53
          {% if main_interface.stdout %}
          interface={{ main_interface.stdout }}
          {% endif %}
          interface=lo

          # Serveurs DNS en amont
          {% for server in upstream_dns %}
          server={{ server }}
          {% endfor %}

          # Pas de DHCP
          no-dhcp-interface=

          # Configuration supplÃ©mentaire
          conf-dir=/etc/dnsmasq.d/,*.conf

          # Logs pour debug
          log-queries
        dest: /etc/dnsmasq.conf
        owner: root
        group: root
        mode: '0644'
        backup: true

    - name: Ensure dnsmasq.d directory exists
      ansible.builtin.file:
        path: /etc/dnsmasq.d
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Create domain-specific configuration
      ansible.builtin.copy:
        content: |
          # Configuration pour {{ dns_domain }}

          # RÃ¨gle spÃ©cifique : stormshield.{{ dns_domain }} â†’ {{ stormshield_ip }}
          address=/stormshield.{{ dns_domain }}/{{ stormshield_ip }}

          # RÃ¨gle spÃ©cifique : kafka.{{ dns_domain }} â†’ 10.0.0.211
          address=/kafka.{{ dns_domain }}/10.0.0.211

          # RÃ¨gle spÃ©cifique : postgres.{{ dns_domain }} â†’ 10.0.0.212
          address=/postgres.{{ dns_domain }}/10.0.0.212

          # RÃ¨gle spÃ©cifique : mongodb.{{ dns_domain }} â†’ 10.0.0.213
          address=/mongodb.{{ dns_domain }}/10.0.0.213

          # RÃ¨gle gÃ©nÃ©rale : *.{{ dns_domain }} â†’ {{ dns_ip }}
          address=/.{{ dns_domain }}/{{ dns_ip }}
        dest: /etc/dnsmasq.d/{{ dns_domain }}.conf
        owner: root
        group: root
        mode: '0644'

    - name: Test dnsmasq configuration syntax
      ansible.builtin.command: dnsmasq --test
      register: config_test
      changed_when: false
      failed_when: config_test.rc != 0

    - name: Start and enable dnsmasq service
      ansible.builtin.systemd:
        name: dnsmasq
        state: started
        enabled: true

    - name: Verify dnsmasq is running
      ansible.builtin.systemd:
        name: dnsmasq
      register: service_status

    - name: Display service status
      ansible.builtin.debug:
        msg: |
          âœ… dnsmasq status: {{ service_status.status.ActiveState }}
          ğŸ”§ Enabled: {{ service_status.status.UnitFileState }}
          ğŸŒ Domain configured:
             - *.{{ dns_domain }} â†’ {{ dns_ip }}
             - stormshield.{{ dns_domain }} â†’ {{ stormshield_ip }}
             - kafka.{{ dns_domain }} â†’
             - postgres.{{ dns_domain }} â†’
             - mongodb.{{ dns_domain }} â†’ 10.0.0.213
          ğŸ“¡ Upstream DNS: {{ upstream_dns | join(', ') }}
