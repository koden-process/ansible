---
- name: Fix K3s Version Mismatch - Upgrade Master to Latest Version
  hosts: k8s_master,k8s_workers
  become: true
  vars:
    # Alignement sur la version la plus r√©cente (celle des workers)
    target_k3s_version: v1.32.6+k3s1
    k3s_install_url: https://get.k3s.io
    
  tasks:
    - name: Display current versions before fix
      block:
        - name: Check current K3s version
          ansible.builtin.shell: /usr/local/bin/k3s --version | head -1
          register: current_version
          failed_when: false
          
        - name: Show current version
          ansible.builtin.debug:
            msg: "{{ inventory_hostname }}: {{ current_version.stdout | default('K3s not found') }}"

    - name: Stop K3s services before upgrade
      block:
        - name: Stop K3s master service
          ansible.builtin.systemd:
            name: k3s
            state: stopped
          when: inventory_hostname in groups['k8s_master']
          failed_when: false
          
        - name: Stop K3s agent services on workers
          ansible.builtin.systemd:
            name: k3s-agent
            state: stopped
          when: inventory_hostname in groups['k8s_workers']
          failed_when: false

    - name: Backup important data (master only)
      block:
        - name: Create backup directory
          ansible.builtin.file:
            path: /root/k3s-backup-{{ ansible_date_time.epoch }}
            state: directory
          when: inventory_hostname in groups['k8s_master']
          
        - name: Backup K3s configuration
          ansible.builtin.copy:
            src: "{{ item }}"
            dest: "/root/k3s-backup-{{ ansible_date_time.epoch }}/"
            remote_src: true
          with_items:
            - /etc/rancher/k3s/k3s.yaml
            - /var/lib/rancher/k3s/server/node-token
          when: inventory_hostname in groups['k8s_master']
          failed_when: false

    - name: Upgrade K3s to target version
      block:
        - name: Download and install K3s master with target version
          ansible.builtin.shell: |
            curl -sfL {{ k3s_install_url }} | INSTALL_K3S_VERSION={{ target_k3s_version }} sh -
          when: inventory_hostname in groups['k8s_master']
          environment:
            INSTALL_K3S_EXEC: "--disable=traefik --write-kubeconfig-mode=644"
          register: master_install
          
        - name: Wait for master to be ready
          ansible.builtin.wait_for:
            port: 6443
            host: "{{ ansible_default_ipv4.address }}"
            delay: 10
            timeout: 120
          when: inventory_hostname in groups['k8s_master']
          
        - name: Start K3s master service
          ansible.builtin.systemd:
            name: k3s
            state: started
            enabled: true
          when: inventory_hostname in groups['k8s_master']

    - name: Get master connection info for workers
      block:
        - name: Read node token from master
          ansible.builtin.slurp:
            src: /var/lib/rancher/k3s/server/node-token
          register: node_token_b64
          when: inventory_hostname in groups['k8s_master']
          
        - name: Set master token as fact
          ansible.builtin.set_fact:
            master_token: "{{ node_token_b64.content | b64decode | trim }}"
          when: inventory_hostname in groups['k8s_master']
          
        - name: Set master IP and token facts for workers
          ansible.builtin.set_fact:
            master_ip: "{{ hostvars[groups['k8s_master'][0]]['ansible_default_ipv4']['address'] }}"
            master_token: "{{ hostvars[groups['k8s_master'][0]]['master_token'] }}"
          when: inventory_hostname in groups['k8s_workers']

    - name: Reinstall workers with correct version
      block:
        - name: Remove old K3s agent installation
          ansible.builtin.file:
            path: "{{ item }}"
            state: absent
          with_items:
            - /usr/local/bin/k3s
            - /etc/systemd/system/k3s-agent.service
            - /etc/systemd/system/k3s-agent.service.env
          when: inventory_hostname in groups['k8s_workers']
          
        - name: Reload systemd after service removal
          ansible.builtin.systemd:
            daemon_reload: true
          when: inventory_hostname in groups['k8s_workers']
          
        - name: Install K3s agent with target version
          ansible.builtin.shell: |
            curl -sfL {{ k3s_install_url }} | INSTALL_K3S_VERSION={{ target_k3s_version }} K3S_URL=https://{{ master_ip }}:6443 K3S_TOKEN={{ master_token }} sh -
          when:
            - inventory_hostname in groups['k8s_workers']
            - master_token is defined
          register: worker_install
          
        - name: Start and enable K3s agent
          ansible.builtin.systemd:
            name: k3s-agent
            state: started
            enabled: true
          when: inventory_hostname in groups['k8s_workers']

    - name: Verification
      block:
        - name: Wait for agents to register
          ansible.builtin.pause:
            seconds: 30
          when: inventory_hostname in groups['k8s_master']
          
        - name: Check cluster status
          ansible.builtin.shell: /usr/local/bin/k3s kubectl get nodes
          register: cluster_status
          when: inventory_hostname in groups['k8s_master']
          
        - name: Display cluster status
          ansible.builtin.debug:
            var: cluster_status.stdout_lines
          when:
            - inventory_hostname in groups['k8s_master']
            - cluster_status.stdout is defined

    - name: Final version check
      block:
        - name: Check final K3s version
          ansible.builtin.shell: /usr/local/bin/k3s --version | head -1
          register: final_version
          
        - name: Show final version
          ansible.builtin.debug:
            msg: "{{ inventory_hostname }} final version: {{ final_version.stdout }}"
