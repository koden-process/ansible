---
- name: Restart K3s Services in Correct Order
  hosts: k8s_master,k8s_workers
  become: true
  serial: 1
  
  tasks:
    - name: Check current K3s version
      ansible.builtin.shell: /usr/local/bin/k3s --version | head -1
      register: current_version
      failed_when: false
      
    - name: Display version
      ansible.builtin.debug:
        msg: "{{ inventory_hostname }}: {{ current_version.stdout | default('K3s not found') }}"

- name: Start K3s Master First
  hosts: k8s_master
  become: true
  
  tasks:
    - name: Start and enable K3s master service
      ansible.builtin.systemd:
        name: k3s
        state: started
        enabled: true
        daemon_reload: true
      register: master_start
      
    - name: Wait for master API to be ready
      ansible.builtin.wait_for:
        port: 6443
        host: "{{ ansible_default_ipv4.address }}"
        delay: 10
        timeout: 60
        
    - name: Verify master is responding
      ansible.builtin.shell: /usr/local/bin/k3s kubectl get nodes
      register: master_check
      retries: 5
      delay: 10
      until: master_check.rc == 0
      
    - name: Show master status
      ansible.builtin.debug:
        var: master_check.stdout_lines

- name: Restart K3s Workers
  hosts: k8s_workers
  become: true
  serial: 1
  
  tasks:
    - name: Stop K3s agent if running
      ansible.builtin.systemd:
        name: k3s-agent
        state: stopped
      failed_when: false
      
    - name: Wait a moment
      ansible.builtin.pause:
        seconds: 5
        
    - name: Start and enable K3s agent
      ansible.builtin.systemd:
        name: k3s-agent
        state: started
        enabled: true
        daemon_reload: true
      register: agent_start
      
    - name: Show agent status
      ansible.builtin.debug:
        msg: "{{ inventory_hostname }} agent started: {{ agent_start.state }}"

- name: Final Cluster Verification
  hosts: k8s_master
  become: true
  
  tasks:
    - name: Wait for all nodes to register
      ansible.builtin.pause:
        seconds: 30
        
    - name: Check final cluster status
      ansible.builtin.shell: /usr/local/bin/k3s kubectl get nodes -o wide
      register: final_status
      
    - name: Display final cluster status
      ansible.builtin.debug:
        var: final_status.stdout_lines