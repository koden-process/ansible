---
- name: Install and configure dnsmasq on koden0
  hosts: k8s_master
  become: true
  vars:
    dns_domain: "amazone.lan"
    dns_ip: "10.0.0.200"
    upstream_dns:
      - "8.8.8.8"
      - "1.1.1.1"
  
  tasks:
    - name: Install dnsmasq package
      package:
        name: dnsmasq
        state: present
    
    - name: Detect main network interface
      shell: |
        ip route | grep default | head -1 | awk '{print $5}'
      register: main_interface
      changed_when: false
      
    - name: Display detected interface
      debug:
        msg: "Interface d√©tect√©e: {{ main_interface.stdout }}"
    
    - name: Stop dnsmasq service
      systemd:
        name: dnsmasq
        state: stopped
      ignore_errors: true
    
    - name: Create main dnsmasq configuration
      copy:
        content: |
          # Configuration dnsmasq pour koden0
          port=53
          {% if main_interface.stdout %}
          interface={{ main_interface.stdout }}
          {% endif %}
          interface=lo
          
          # Serveurs DNS en amont
          {% for server in upstream_dns %}
          server={{ server }}
          {% endfor %}
          
          # Pas de DHCP
          no-dhcp-interface=
          
          # Configuration suppl√©mentaire
          conf-dir=/etc/dnsmasq.d/,*.conf
          
          # Logs pour debug
          log-queries
        dest: /etc/dnsmasq.conf
        owner: root
        group: root
        mode: '0644'
        backup: true
    
    - name: Create domain-specific configuration
      copy:
        content: |
          # Configuration pour {{ dns_domain }}
          address=/.{{ dns_domain }}/{{ dns_ip }}
        dest: /etc/dnsmasq.d/{{ dns_domain }}.conf
        owner: root
        group: root
        mode: '0644'
    
    - name: Create dnsmasq.d directory
      file:
        path: /etc/dnsmasq.d
        state: directory
        owner: root
        group: root
        mode: '0755'
    
    - name: Test dnsmasq configuration syntax
      command: dnsmasq --test
      register: config_test
      changed_when: false
      failed_when: config_test.rc != 0
    
    - name: Start and enable dnsmasq service
      systemd:
        name: dnsmasq
        state: started
        enabled: true
    
    - name: Verify dnsmasq is running
      systemd:
        name: dnsmasq
      register: service_status
      
    - name: Display service status
      debug:
        msg: |
          ‚úÖ dnsmasq status: {{ service_status.status.ActiveState }}
          üîß Enabled: {{ service_status.status.UnitFileState }}
          üåê Domain configured: *.{{ dns_domain }} ‚Üí {{ dns_ip }}
          üì° Upstream DNS: {{ upstream_dns | join(', ') }}